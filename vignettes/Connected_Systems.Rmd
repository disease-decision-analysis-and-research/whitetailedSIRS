---
title: "SARS-CoV-2 introduction and spread in connected systems"
subtitle: "Analysis referenced in Rosenblatt et al. In Prep"
author: "Elias Rosenblatt"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SARS-CoV-2 introduction and spread in connected systems}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup, include = FALSE}
library(whitetailedSIRS)
library(tidyverse)
library(deSolve)
library(rootSolve)
library(binom)
library(kableExtra)
```

## Introduction
Now that we have a dataset from each scenario (whitetailedSIRS::SIRS_analysis_by_contexts), we can test how connected systems (wild and captive separated by a fence line) differ in outbreak characteristics, compared to isolated scenario. When these scenarios are connected, there may be differences in prevalence, cumulative cases, and persistence due to fence line interactions. This analysis corresponds with Objective 5 of *Rosenblatt et al. In Prep*.

## Data input and common parameter values
Here, we load the dataset and remind R how many iterations were run in each context (nsamples). We set a seed for consistent results, identify human prevalence and duration of projection (days). We then set parameters that are used consistently across all simulations in the vignette.

```{r}
set.seed(23)
df <- whitetailedSIRS::scenario_results
nsamples <- 200

#Bring in estimates from expert elicitation
elicitation_data <- draw_elicitation_samples(nsamples = nsamples)

#Fixed parameters
I_human_null <- 0.05
times <- seq(0, 120, by = 1)

#Parameters commonly used across projections
nWild <- rpois(nsamples,1000) #Abundance
A_w <- 100 #Area
habitat <- "med" #Habitat classification

C_nu_human <- rnorm(n = nsamples, mean = 10^5.6, sd = 10^1.2)#viral load in humans (genomic copies per ml)
C_nu_deer <- 10^5.6 * get_EE_param_vals(data = elicitation_data, my_param = "Viral Load") #viral load in deer saliva, relative to humans (genomic copies per ml)

r_deer <- get_EE_param_vals(data = elicitation_data, my_param = "Dose-Response")# Dose response coefficient for deer and SARS-CoV-2

epsilon_dc <- get_EE_param_vals(data = elicitation_data, my_param = "Direct Contact Probability") #Probability of direct contact between deer, given proximity.

sigma_dc_deer_deer_null <- calc_sigma_dc(C_nu = C_nu_deer, nsamples = nsamples) #Infection probability of 0.1 ml of saliva being transferred between deer on contact

t_contact_deer_deer_null <- get_EE_param_vals(data = elicitation_data, my_param = "Deer Proximity Duration (minutes)") #Estimate duration of deer-deer proximity event...

inits.fall <- initial_compartments(draws = nsamples) #Calculate initial distributions of animals across SIR compartments
inits.steady <- initial_compartments(draws = nsamples, steady = TRUE) #Calculate initial distributions of animals across SIR compartments, excluding solving cumulative cases.

gamma_recov <- rep(1/6, nsamples)
alpha_immunity_null <- 1 / get_EE_param_vals(data = elicitation_data, my_param = 'Temporary Immunity')
```

## System calculation
Below, we combine a wild scenario and a captive scenario, with a fence line separating these populations. For each combination, we define new parameters that have not been defined previously. As we work through these combinations, fewer parameters are added as they exist in earlier combinations.

### Captive deer in outdoor ranch facilties connected to wild, rural deer
```{r}
#Ranch side of the fence...
omega_cc_ranch <- calc_contact_rate(nsamples = nsamples, type_contact = habitat, N_w = nWild)*(get_EE_param_vals(data = elicitation_data, my_param = "Proximity rate with baiting (17 events without baiting)")/17) #Deer-to-deer proximity rate in ranch context, mimicking wild proximity rates with the influence of baiting (events per day).

sigma_aero_deer_deer_null <- calc_sigma_aero(C_nu = C_nu_deer,
                                        t_contact = t_contact_deer_deer_null / 60,
                                        r = r_deer, nsamples = nsamples) #...and estimate probability of infection given that duration of proximity event.

t_contact_deer_human_ranch <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Captive (minutes)") #Estimate duration of human-deer proximity event in ranch facility context...

omega_hc_ranch <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120 #Human-to-deer proximity rate in ranch context, mimicking suburban proximitty rates (events per day).

sigma_aero_deer_human_ranch <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_ranch / 60,
                                        r = r_deer, nsamples = nsamples)#... and calculate infection probability given the duration of a human-deer proximity event.

#Fenceline interactions occure
omega_cw <- 0.00072 / get_EE_param_vals(data = elicitation_data, my_param = "Direct Contact Probability") #Deer-to-deer proximity rate along fenceline (events per day).

#... and on the wild side of the fence:
omega_ww <- calc_contact_rate(nsamples = nsamples, type_contact = habitat, N_w = nWild)

t_contact_deer_human_rural <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Rural (minutes)")

omega_hw_rural <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Rural (per 120 days)") /120

sigma_aero_deer_human_rural <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_rural / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

ranch_rural.params <- alternative(alpha_immunity = alpha_immunity_null,
                            omega_ww = omega_ww, omega_cw = omega_cw, omega_cc = omega_cc_ranch,
                            omega_hw = omega_hw_rural, omega_hc = omega_hc_ranch,
                            sigma_aero_deer_deer_wild = sigma_aero_deer_deer_null, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_null, sigma_aero_deer_human_wild = sigma_aero_deer_human_rural, sigma_aero_deer_human_capt = sigma_aero_deer_human_ranch, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer_null, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))

proj_ranch_rural <- run(iter = nsamples, initial_compartments = inits.fall, initial_compartments_steady = inits.steady, params = ranch_rural.params, times = times, name = "Outdoor ranch and rural system")
```

### Captive deer in outdoor ranch facilties connected to wild, suburban deer
Below we modify what's happening on the wild side of the fence to a suburban context, and can keep the captive side parameterized to describe the outdoor ranch facility scenario.
```{r}
t_contact_deer_human_suburban <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Suburban (minutes)")

omega_hw_suburban <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120

sigma_aero_deer_human_suburban <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_suburban / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

ranch_suburban.params <- alternative(alpha_immunity = alpha_immunity_null,
                            omega_ww = omega_ww, omega_cw = omega_cw, omega_cc = omega_cc_ranch,
                            omega_hw = omega_hw_suburban, omega_hc = omega_hc_ranch,
                            sigma_aero_deer_deer_wild = sigma_aero_deer_deer_null, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_null, sigma_aero_deer_human_wild = sigma_aero_deer_human_suburban, sigma_aero_deer_human_capt = sigma_aero_deer_human_ranch, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer_null, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))

proj_ranch_suburban <- run(iter = nsamples, initial_compartments = inits.fall, initial_compartments_steady = inits.steady, params = ranch_suburban.params, times = times, name = "Outdoor ranch and suburban system")
```

### Captive deer in intensive facilties connected to wild, rural deer
Since we have defined parameter sets for both wild scenarios, below we modify what's happening on the captive side of the fence.

```{r}
omega_cc_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Deer Proximity Rate, Captive (per day)")

sigma_aero_deer_deer_intensive <- calc_sigma_aero(C_nu = C_nu_deer,
                                            t_contact = t_contact_deer_deer_null / 60,
                                            r = r_deer, nsamples = nsamples, AER = rep(1, nsamples))

omega_hc_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120

t_contact_deer_human_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Captive (minutes)") 

sigma_aero_deer_human_intensive <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                            t_contact = t_contact_deer_human_intensive / 60,
                                            r = r_deer, nsamples = nsamples, AER = rep(1, nsamples))

intensive_rural.params <- alternative(alpha_immunity = alpha_immunity_null,
                            omega_ww = omega_ww, omega_cw = omega_cw, omega_cc = omega_cc_intensive,
                            omega_hw = omega_hw_rural, omega_hc = omega_hc_intensive,
                            sigma_aero_deer_deer_wild = sigma_aero_deer_deer_null, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_intensive, sigma_aero_deer_human_wild = sigma_aero_deer_human_rural, sigma_aero_deer_human_capt = sigma_aero_deer_human_intensive, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer_null, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))

proj_intensive_rural <- run(iter = nsamples, initial_compartments = inits.fall, initial_compartments_steady = inits.steady, params = intensive_rural.params, times = times, name = "Intensive facility and rural system")
```

### Captive deer in intensive facilties connected to wild, suburban deer
Finally, the final combination of intensive captive facilities and wild, suburban deer.

```{r}
intensive_suburban.params <- alternative(alpha_immunity = alpha_immunity_null,
                            omega_ww = omega_ww, omega_cw = omega_cw, omega_cc = omega_cc_intensive,
                            omega_hw = omega_hw_suburban, omega_hc = omega_hc_intensive,
                            sigma_aero_deer_deer_wild = sigma_aero_deer_deer_null, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_intensive, sigma_aero_deer_human_wild = sigma_aero_deer_human_suburban, sigma_aero_deer_human_capt = sigma_aero_deer_human_intensive, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer_null, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))

proj_intensive_suburban <- run(iter = nsamples, initial_compartments = inits.fall, initial_compartments_steady = inits.steady, params = intensive_suburban.params, times = times, name = "Intensive facility and suburban system")
```

## Summarize prevalence, cumulative infections, and persistence for each system
As we did in `whitetailedSIRS::SIRS_analysis_by_context`, we compute the average prevalence, cumulative infections, and persistence for each system (captive:wild scenario combination).

```{r}
persist.threshold <- 0.001 #Set prevalence threshold

#Ranch and rural system
proj_ranch_rural %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(proj_ranch_rural$Context)[1],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
  summarize(Wild = mean(I_wild), Captive = mean(I_captive), Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative)) %>% 
   mutate(., Context = factor(Context, levels = c("Outdoor ranch and rural system"))) %>% 
  arrange(., run_id) -> Prev_cumulative_ranch_rural_system_df

proj_ranch_rural %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(proj_ranch_rural$Context)[1],nsamples))) %>%
  mutate(., Persist_wild = I_wild > persist.threshold, Persist_captive = I_captive > persist.threshold) %>%
   mutate(., Context = factor(Context, levels = c("Outdoor ranch and rural system"))) %>% 
  select(., run_id, Context, Persist_wild, Persist_captive) %>% 
   merge(Prev_cumulative_ranch_rural_system_df,.) %>% 
      arrange(., run_id)-> Prev_cumulative_persist_ranch_rural_system_df

#Ranch and suburban system
proj_ranch_suburban %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(proj_ranch_suburban$Context)[1],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
  summarize(Wild = mean(I_wild), Captive = mean(I_captive), Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative)) %>% 
   mutate(., Context = factor(Context, levels = c("Outdoor ranch and suburban system"))) %>% 
  arrange(., run_id) -> Prev_cumulative_ranch_suburban_system_df

proj_ranch_suburban %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(proj_ranch_suburban$Context)[1],nsamples))) %>%
  mutate(., Persist_wild = I_wild > persist.threshold, Persist_captive = I_captive > persist.threshold) %>%
   mutate(., Context = factor(Context, levels = c("Outdoor ranch and suburban system"))) %>% 
  select(., run_id, Context, Persist_wild, Persist_captive) %>% 
   merge(Prev_cumulative_ranch_suburban_system_df,.) %>% 
      arrange(., run_id)-> Prev_cumulative_persist_ranch_suburban_system_df

#Intensive facility and rural system
proj_intensive_rural %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(proj_intensive_rural$Context)[1],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
  summarize(Wild = mean(I_wild), Captive = mean(I_captive), Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative)) %>% 
   mutate(., Context = factor(Context, levels = c("Intensive facility and rural system"))) %>% 
  arrange(., run_id) -> Prev_cumulative_intensive_rural_system_df

proj_intensive_rural %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(proj_intensive_rural$Context)[1],nsamples))) %>%
  mutate(., Persist_wild = I_wild > persist.threshold, Persist_captive = I_captive > persist.threshold) %>%
   mutate(., Context = factor(Context, levels = c("Intensive facility and rural system"))) %>% 
  select(., run_id, Context, Persist_wild, Persist_captive) %>% 
   merge(Prev_cumulative_intensive_rural_system_df,.) %>% 
      arrange(., run_id)-> Prev_cumulative_persist_intensive_rural_system_df

#Ranch and suburban system
proj_intensive_suburban %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(proj_intensive_suburban$Context)[1],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
  summarize(Wild = mean(I_wild), Captive = mean(I_captive), Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative)) %>% 
   mutate(., Context = factor(Context, levels = c("Intensive facility and suburban system"))) %>% 
  arrange(., run_id) -> Prev_cumulative_intensive_suburban_system_df

proj_intensive_suburban %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(proj_intensive_suburban$Context)[1],nsamples))) %>%
  mutate(., Persist_wild = I_wild > persist.threshold, Persist_captive = I_captive > persist.threshold) %>%
   mutate(., Context = factor(Context, levels = c("Intensive facility and suburban system"))) %>% 
  select(., run_id, Context, Persist_wild, Persist_captive) %>% 
   merge(Prev_cumulative_intensive_suburban_system_df,.) %>% 
      arrange(., run_id)-> Prev_cumulative_persist_intensive_suburban_system_df

```

## Compare outbreak metrics to simulations with isolated scenarios

Below, we take the results from `whitetailedSIRS::SIRS_analysis_by_contexts` and calculate differences in prevalence, cumulative infections, and persistence when fenceline interactions can occur.

```{r}
#Calculate change in prevalence and persistence
#step 1: prep single context run_ids to correspond to systems
df %>% 
   mutate(., run_id = case_when(Context == "Outdoor ranch" ~ run_id-0,
      Context == "Intensive facility" ~ run_id-200,
      Context == "Wild, rural" ~ run_id-400,
      Context == "Wild, suburban" ~ run_id-600,)) -> df_to_match

#Ranch, rural
Prev_cumulative_persist_ranch_rural_system_df %>% 
   merge(., df_to_match[which(df_to_match$Context== "Outdoor ranch"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "System_wild_prevalence" = "Wild", "System_captive_prevalence" = "Captive", "System_wild_cumulative" = "Cumulative_wild_infections", "System_captive_cumulative" = "Cumulative_captive_infections","System_wild_persistence" = "Persist_wild", "System_captive_persistence" = "Persist_captive", "Context_captive_prevalence" = "Prevalence", "Context_captive_persistence" = "Persist", "Context_captive_cumulative" = "Cumulative_infections") %>% 
   merge(., df_to_match[which(df_to_match$Context== "Wild, rural"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "Context_wild_prevalence" = "Prevalence", "Context_wild_persistence" = "Persist", "Context_wild_cumulative" = "Cumulative_infections") %>% 
   mutate(., Change_Prev_Wild = System_wild_prevalence - Context_wild_prevalence, 
          Change_Prev_Captive = System_captive_prevalence - Context_captive_prevalence, 
          Proportional_Change_Prev_Wild = Change_Prev_Wild/Context_wild_prevalence, 
          Proportional_Change_Prev_Captive = Change_Prev_Captive/Context_captive_prevalence, 
          Change_Cumulative_Wild = System_wild_cumulative - Context_wild_cumulative, 
          Change_Cumulative_Captive = System_captive_cumulative - Context_captive_cumulative, 
          Change_Persist_Wild = System_wild_persistence - Context_wild_persistence, 
          Change_Persist_Captive = System_captive_persistence - Context_captive_persistence) %>% 
   select(., Context, Change_Prev_Wild, Change_Prev_Captive, Proportional_Change_Prev_Wild, Proportional_Change_Prev_Captive, Change_Cumulative_Wild, Change_Cumulative_Captive, Change_Persist_Wild, Change_Persist_Captive) %>% 
   rename(., System = Context) -> ranch_rural_results

#Ranch, suburban
Prev_cumulative_persist_ranch_suburban_system_df %>% 
   merge(., df_to_match[which(df_to_match$Context== "Outdoor ranch"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "System_wild_prevalence" = "Wild", "System_captive_prevalence" = "Captive", "System_wild_cumulative" = "Cumulative_wild_infections", "System_captive_cumulative" = "Cumulative_captive_infections","System_wild_persistence" = "Persist_wild", "System_captive_persistence" = "Persist_captive", "Context_captive_prevalence" = "Prevalence", "Context_captive_persistence" = "Persist", "Context_captive_cumulative" = "Cumulative_infections") %>% 
   merge(., df_to_match[which(df_to_match$Context== "Wild, suburban"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "Context_wild_prevalence" = "Prevalence", "Context_wild_persistence" = "Persist", "Context_wild_cumulative" = "Cumulative_infections") %>% 
   mutate(., Change_Prev_Wild = System_wild_prevalence - Context_wild_prevalence, 
          Change_Prev_Captive = System_captive_prevalence - Context_captive_prevalence, 
          Proportional_Change_Prev_Wild = Change_Prev_Wild/Context_wild_prevalence, 
          Proportional_Change_Prev_Captive = Change_Prev_Captive/Context_captive_prevalence, 
          Change_Cumulative_Wild = System_wild_cumulative - Context_wild_cumulative, 
          Change_Cumulative_Captive = System_captive_cumulative - Context_captive_cumulative, 
          Change_Persist_Wild = System_wild_persistence - Context_wild_persistence, 
          Change_Persist_Captive = System_captive_persistence - Context_captive_persistence) %>% 
   select(., Context, Change_Prev_Wild, Change_Prev_Captive, Proportional_Change_Prev_Wild, Proportional_Change_Prev_Captive, Change_Cumulative_Wild, Change_Cumulative_Captive, Change_Persist_Wild, Change_Persist_Captive) %>% 
   rename(., System = Context) -> ranch_suburban_results

#Intensive, rural
Prev_cumulative_persist_intensive_rural_system_df %>% 
   merge(., df_to_match[which(df_to_match$Context== "Intensive facility"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "System_wild_prevalence" = "Wild", "System_captive_prevalence" = "Captive", "System_wild_cumulative" = "Cumulative_wild_infections", "System_captive_cumulative" = "Cumulative_captive_infections","System_wild_persistence" = "Persist_wild", "System_captive_persistence" = "Persist_captive", "Context_captive_prevalence" = "Prevalence", "Context_captive_persistence" = "Persist", "Context_captive_cumulative" = "Cumulative_infections") %>% 
   merge(., df_to_match[which(df_to_match$Context== "Wild, rural"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "Context_wild_prevalence" = "Prevalence", "Context_wild_persistence" = "Persist", "Context_wild_cumulative" = "Cumulative_infections") %>% 
   mutate(., Change_Prev_Wild = System_wild_prevalence - Context_wild_prevalence, 
          Change_Prev_Captive = System_captive_prevalence - Context_captive_prevalence, 
          Proportional_Change_Prev_Wild = Change_Prev_Wild/Context_wild_prevalence, 
          Proportional_Change_Prev_Captive = Change_Prev_Captive/Context_captive_prevalence, 
          Change_Cumulative_Wild = System_wild_cumulative - Context_wild_cumulative, 
          Change_Cumulative_Captive = System_captive_cumulative - Context_captive_cumulative, 
          Change_Persist_Wild = System_wild_persistence - Context_wild_persistence, 
          Change_Persist_Captive = System_captive_persistence - Context_captive_persistence) %>% 
   select(., Context, Change_Prev_Wild, Change_Prev_Captive, Proportional_Change_Prev_Wild, Proportional_Change_Prev_Captive, Change_Cumulative_Wild, Change_Cumulative_Captive, Change_Persist_Wild, Change_Persist_Captive) %>% 
   rename(., System = Context) -> intensive_rural_results

#Intensive, suburban
Prev_cumulative_persist_intensive_suburban_system_df %>% 
   merge(., df_to_match[which(df_to_match$Context== "Intensive facility"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "System_wild_prevalence" = "Wild", "System_captive_prevalence" = "Captive", "System_wild_cumulative" = "Cumulative_wild_infections", "System_captive_cumulative" = "Cumulative_captive_infections","System_wild_persistence" = "Persist_wild", "System_captive_persistence" = "Persist_captive", "Context_captive_prevalence" = "Prevalence", "Context_captive_persistence" = "Persist", "Context_captive_cumulative" = "Cumulative_infections") %>% 
   merge(., df_to_match[which(df_to_match$Context== "Wild, suburban"),c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id") %>% 
   rename(., "Context_wild_prevalence" = "Prevalence", "Context_wild_persistence" = "Persist", "Context_wild_cumulative" = "Cumulative_infections") %>% 
   mutate(., Change_Prev_Wild = System_wild_prevalence - Context_wild_prevalence, 
          Change_Prev_Captive = System_captive_prevalence - Context_captive_prevalence, 
          Proportional_Change_Prev_Wild = Change_Prev_Wild/Context_wild_prevalence, 
          Proportional_Change_Prev_Captive = Change_Prev_Captive/Context_captive_prevalence, 
          Change_Cumulative_Wild = System_wild_cumulative - Context_wild_cumulative, 
          Change_Cumulative_Captive = System_captive_cumulative - Context_captive_cumulative, 
          Change_Persist_Wild = System_wild_persistence - Context_wild_persistence, 
          Change_Persist_Captive = System_captive_persistence - Context_captive_persistence) %>% 
   select(., Context, Change_Prev_Wild, Change_Prev_Captive, Proportional_Change_Prev_Wild, Proportional_Change_Prev_Captive, Change_Cumulative_Wild, Change_Cumulative_Captive, Change_Persist_Wild, Change_Persist_Captive) %>% 
   rename(., System = Context) -> intensive_suburban_results
```

We can then combine and summarize the differences in outbreak metrics. The resulting table is presented in *Rosenblatt et al. In Prep* as Table 2.

```{r}
sirs_results_systems <- rbind(ranch_suburban_results,intensive_suburban_results,ranch_rural_results,intensive_rural_results)

sirs_results_systems %>% 
   group_by(., System) %>% 
   summarise(., Wild_Prevalence_Change = paste0(round(median(Change_Prev_Wild)*100,4), " (", round(quantile(Change_Prev_Wild,probs = 0.1)*100,4), "-",round(quantile(Change_Prev_Wild,probs = 0.9)*100,4),")"), Captive_Prevalence_Change = paste0(round(median(Change_Prev_Captive)*100,4), " (", round(quantile(Change_Prev_Captive,probs = 0.1)*100,4), "-",round(quantile(Change_Prev_Captive,probs = 0.9)*100,4),")"), 
             Wild_Prevalence_Proportional_Change = paste0(round(median(Proportional_Change_Prev_Wild)*100,4), " (", round(quantile(Proportional_Change_Prev_Wild,probs = 0.1)*100,4), "-",round(quantile(Proportional_Change_Prev_Wild,probs = 0.9)*100,4),")"), Proportional_Captive_Prevalence_Change = paste0(round(median(Proportional_Change_Prev_Captive)*100,4), " (", round(quantile(Proportional_Change_Prev_Captive,probs = 0.1)*100,4), "-",round(quantile(Proportional_Change_Prev_Captive,probs = 0.9)*100,4),")"),
             Wild_Cumulative_Change = paste0(round(median(Change_Cumulative_Wild)*100,4), " (", round(quantile(Change_Cumulative_Wild,probs = 0.1)*100,4), "-",round(quantile(Change_Cumulative_Wild,probs = 0.9)*100,4),")"), Captive_Cumulative_Change = paste0(round(median(Change_Cumulative_Captive)*100,4), " (", round(quantile(Change_Cumulative_Captive,probs = 0.1)*100,4), "-",round(quantile(Change_Cumulative_Captive,probs = 0.9)*100,4),")"), 
             Wild_Persist_Change = paste0(round(binom.confint(sum(Change_Persist_Wild),nsamples,methods = "exact")$mean,2), " (", round(binom.confint(sum(Change_Persist_Wild),nsamples,methods = "exact", conf.level = 0.80)$lower,2), "-", round(binom.confint(sum(Change_Persist_Wild),nsamples,methods = "exact", conf.level = 0.80)$upper,2), ")"),
             Captive_Persist_Change = sum(Change_Persist_Captive)) ->fence_effect

fence_effect %>%
  kbl() %>%
  kable_paper("hover", full_width = T)
```
