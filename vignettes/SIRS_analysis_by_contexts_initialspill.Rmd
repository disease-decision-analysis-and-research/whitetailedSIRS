---
title: "SARS-CoV-2 outbreak characteristics across wild and captive settings, with an intial spillover"
subtitle: "Analysis referenced in Rosenblatt et al. In Prep"
author: "Elias Rosenblatt"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SIRS_analysis_by_contexts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
library(whitetailedSIRS)
library(tidyverse)
library(deSolve)
library(rootSolve)
library(binom)
library(kableExtra)
```

## Introduction
This vignette follows the same blueprint as `whitetailedSIRS::SIRS_analysis_by_context`. The primary difference here is that initial infected compartment sizes are set non-zero values and human prevalence is set to zero. This mimics an initial spillover event of a given magnitude, to test how outbreak dynamics differ from continuous spillover detailed in `whitetailedSIRS::SIRS_analysis_by_context`. These differences are visualized in the vignette `whitetailedSIRS::Visualize_by_context`. Most of the simulation code is suppresed in the rendered vignette, but can be viewed in the .Rmd file. This analysis corresponds with Objective 4 of *Rosenblatt et al. In Prep*.

```{r base_simulations, echo=FALSE}
set.seed(23)
nsamples <- 200
I_human_null <- 0
times <- seq(0, 120, by = 1)
```

```{r, echo=FALSE}
elicitation_data <- draw_elicitation_samples(nsamples = nsamples)
```

```{r Ranch Proximity, echo=FALSE}
nWild <- rpois(nsamples,1000) #Abundance
A_w <- 100 #Area
habitat <- "med" #Habitat classification

epsilon_dc <- get_EE_param_vals(data = elicitation_data, my_param = "Direct Contact Probability") #Probability of direct contact between deer, given proximity.
```

```{r, echo=FALSE}
omega_ww_ranch <- rep(0, nsamples) #Deer-to-deer proximity rate in wild (set to 0; events per day).
omega_cw_null <- rep(0, nsamples) #Deer-to-deer proximity rate along fenceline (set to 0; events per day).
omega_cc_ranch <- calc_contact_rate(nsamples = nsamples, type_contact = habitat, N_w = nWild, rho_attractant = get_EE_param_vals(data = elicitation_data, my_param = "Proximity rate with baiting (17 events without baiting)")/17) #Deer-to-deer proximity rate in ranch context, mimicing wild proximity rates with the influence of baiting (events per day).

omega_hw_ranch <- rep(0, nsamples) #Human-to-deer proximity rate in wild (set to 0; events per day).
omega_hc_ranch <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120 #Human-to-deer proximity rate in ranch context, mimicing suburban proximitty rates (events per day).
```

```{r common infection parameters, echo=FALSE}
C_nu_human <- rnorm(n = nsamples, mean = 10^5.6, sd = 10^1.2)#viral load in humans (genomic copies per ml)
C_nu_deer <- 10^5.6 * get_EE_param_vals(data = elicitation_data, my_param = "Viral Load") #viral load in deer saliva, relative to humans (genomic copies per ml)

r_deer <- get_EE_param_vals(data = elicitation_data, my_param = "Dose-Response")# Dose response coefficient for deer and SARS-CoV-2
```


``` {r infection probability, echo=FALSE}
#Infection probability calculation of aerosol transmission from deer-to-deer
t_contact_deer_deer_null <- get_EE_param_vals(data = elicitation_data, my_param = "Deer Proximity Duration (minutes)") #Estimate duration of proximity event...
sigma_aero_deer_deer_ranch <- calc_sigma_aero(C_nu = C_nu_deer,
                                        t_contact = t_contact_deer_deer_null / 60,
                                        r = r_deer, nsamples = nsamples) #...and estimate probability of infection given that duration of proximity event.

sigma_aero_deer_deer_wild_null <- rep(0, nsamples) #Estimate infection probability in out in the wild as 0 (needs to be included for SIRS ODE equations)

#Infection probability of 0.1 ml of saliva being transferred between deer on contact
sigma_dc_deer_deer_null <- calc_sigma_dc(C_nu = C_nu_deer, nsamples = nsamples) #Calculate infection probability

#Infection probability calculation of aerosol transmission from humans-to-deer
t_contact_deer_human_ranch <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Captive (minutes)") #Estimate duration of human-deer proximity event in ranch facility context...
sigma_aero_deer_human_ranch <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_ranch / 60,
                                        r = r_deer, nsamples = nsamples)#... and calculate infection probability given the duration of a human-deer proximity event.
sigma_aero_deer_human_wild_null <- rep(0, nsamples)#Estimate human-to-deer infection probability out in the wild as 0 (needs to be included for SIRS ODE equations)

```

```{r, echo=FALSE}
gamma_recov <- rep(1/6, nsamples)
alpha_immunity_null <- 1 / get_EE_param_vals(data = elicitation_data, my_param = 'Temporary Immunity')

ranch.params <- alternative(alpha_immunity = alpha_immunity_null,
                            omega_ww = omega_ww_ranch, omega_cw = omega_cw_null,omega_cc = omega_cc_ranch,
                            omega_hw = omega_hw_ranch, omega_hc = omega_hc_ranch,
                            sigma_aero_deer_deer_wild = sigma_aero_deer_deer_wild_null, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_ranch, sigma_aero_deer_human_wild = sigma_aero_deer_human_wild_null, sigma_aero_deer_human_capt = sigma_aero_deer_human_ranch, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer_null, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))
```

```{r intensive captive, echo = FALSE}
omega_ww_intensive <- rep(0, nsamples)
omega_cc_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Deer Proximity Rate, Captive (per day)")
omega_hw_intensive <- rep(0, nsamples)
omega_hc_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120

sigma_aero_deer_deer_intensive <- calc_sigma_aero(C_nu = C_nu_deer,
                                            t_contact = t_contact_deer_deer_null / 60,
                                            r = r_deer, nsamples = nsamples, AER = rep(1, nsamples))

t_contact_deer_human_intensive <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Captive (minutes)") 

sigma_aero_deer_human_intensive <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                            t_contact = t_contact_deer_human_intensive / 60,
                                            r = r_deer, nsamples = nsamples, AER = rep(1, nsamples))

intensive.params <- alternative(
   omega_ww = omega_ww_intensive, omega_cw = omega_cw_null, omega_cc = omega_cc_intensive, 
   omega_hw = omega_hw_intensive, omega_hc = omega_hc_intensive, 
   sigma_aero_deer_deer_wild = sigma_aero_deer_human_wild_null, sigma_aero_deer_deer_captive =  sigma_aero_deer_deer_intensive, sigma_aero_deer_human_wild = sigma_aero_deer_human_wild_null, sigma_aero_deer_human_capt = sigma_aero_deer_human_intensive, sigma_dc_deer_deer = sigma_dc_deer_deer_null,
   alpha_immunity = alpha_immunity_null, epsilon_dc = epsilon_dc, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))
```


```{r wild and rural, echo = FALSE}
omega_ww_rural <- calc_contact_rate(nsamples = nsamples, type_contact = habitat, N_w = nWild)
omega_cc_rural <- rep(0, nsamples)
omega_hw_rural <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Rural (per 120 days)") /120
omega_hc_rural <- rep(0, nsamples)

t_contact_deer_human_rural <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Rural (minutes)")

sigma_aero_deer_deer_rural <- calc_sigma_aero(C_nu = C_nu_deer,
                                        t_contact = t_contact_deer_deer_null / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

sigma_aero_deer_deer_captive_null <- rep(0, nsamples)

sigma_aero_deer_human_rural <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_rural / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

sigma_aero_deer_human_captive_null <- rep(0, nsamples)

wild.inits.fall <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999, I_wild_prop = 0.001, draws = nsamples)
wild.inits.steady <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999, I_wild_prop = 0.001, draws = nsamples, steady = TRUE)

rural.params <- alternative(omega_ww = omega_ww_rural, omega_cw = omega_cw_null, omega_cc = omega_cc_rural, omega_hw = omega_hw_rural, omega_hc = omega_hc_rural, sigma_aero_deer_deer_wild = sigma_aero_deer_deer_rural, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_captive_null, sigma_aero_deer_human_wild = sigma_aero_deer_human_rural,  sigma_aero_deer_human_capt = sigma_aero_deer_human_captive_null, sigma_dc_deer_deer = sigma_dc_deer_deer_null,alpha_immunity = alpha_immunity_null, epsilon_dc = epsilon_dc, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))

```

```{r wild and captive}
omega_ww_suburban <- calc_contact_rate(nsamples = nsamples, type_contact = habitat, N_w = nWild)
omega_cc_suburban <- rep(0, nsamples)
omega_hw_suburban <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Rate, Suburban (per 120 days)") /120
omega_hc_suburban <- rep(0, nsamples)

t_contact_deer_human_suburban <- get_EE_param_vals(data = elicitation_data, my_param = "Deer-Human Proximity Duration, Suburban (minutes)")

sigma_aero_deer_deer_suburban <- calc_sigma_aero(C_nu = C_nu_deer,
                                        t_contact = t_contact_deer_deer_null / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

sigma_aero_deer_human_suburban <- calc_sigma_aero(ER = 0.53, C_nu = C_nu_human, 
                                        t_contact = t_contact_deer_human_suburban / 60,
                                        r = r_deer, nsamples = nsamples, AER = rep(4, nsamples))

suburban.params <- alternative(omega_ww = omega_ww_suburban, omega_cw = omega_cw_null, omega_cc = omega_cc_suburban, omega_hw = omega_hw_suburban, omega_hc = omega_hc_suburban, sigma_aero_deer_deer_wild = sigma_aero_deer_deer_suburban, sigma_aero_deer_deer_captive = sigma_aero_deer_deer_captive_null, sigma_aero_deer_human_wild = sigma_aero_deer_human_suburban,  sigma_aero_deer_human_capt = sigma_aero_deer_human_captive_null, sigma_dc_deer_deer = sigma_dc_deer_deer_null,alpha_immunity = alpha_immunity_null, epsilon_dc = epsilon_dc, gamma_recov = gamma_recov, I_human = rep(I_human_null, nsamples), boost = rep(0, nsamples))
```

## Compile parameters and run SIRS ODE solver for context
With the same transmission parameters as we used in `whitetailedSIRS::SIRS_analysis_by_context`, we can compile a result dataset for intial outbreaks of different sizes.
```{r Compiler 1:1000, warning=FALSE, message=FALSE}
captive.inits.fall <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999, I_captive_prop = 0.001, draws = nsamples)
captive.inits.steady <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999, I_captive_prop = 0.001, draws = nsamples, steady = TRUE)

wild.inits.fall <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999, I_wild_prop = 0.001, draws = nsamples)
wild.inits.steady <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999, I_wild_prop = 0.001, draws = nsamples, steady = TRUE)

proj.ranch <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = ranch.params, times = times, name = "Outdoor ranch")

proj.intensive <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = intensive.params, times = times, name = "Intensive facility")

proj.rural <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady ,params = rural.params, times = times, name = "Wild, rural")

proj.suburban <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady, params = suburban.params, times = times, name = "Wild, suburban")
```

```{r, Summarize prev and cumulative infections, echo=FALSE, message = FALSE}
sirs_results_contexts <- rbind(proj.ranch,proj.intensive, proj.rural, proj.suburban)

sirs_results_contexts %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[2],length(times)*nsamples), rep(unique(sirs_results_contexts$Context)[3],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[4],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
   summarize(Wild = mean(I_wild), Captive = mean(I_captive), Prevalence = Wild + Captive, Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative), Cumulative_infections = sum(Cumulative_wild_infections,Cumulative_captive_infections)) %>% 
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
   select(., -Wild, -Captive, -Cumulative_wild_infections, -Cumulative_captive_infections) %>% 
  group_by(.,Context) %>% 
  arrange(., Context, run_id) -> Prev_cumulative_df

```

```{r, Summarize persistence, echo = F, warning=FALSE, message=FALSE}

persist.threshold <- 0.001

sirs_results_contexts %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],nsamples),rep(unique(sirs_results_contexts$Context)[2],nsamples), rep(unique(sirs_results_contexts$Context)[3],nsamples),rep(unique(sirs_results_contexts$Context)[4],nsamples))) %>%
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
  mutate(., Persist.I_wild = I_wild > persist.threshold, Persist.I_captive = I_captive > persist.threshold, Persist = as.logical(Persist.I_wild + Persist.I_captive)) %>%
  select(., run_id,Context, Persist) %>%
  arrange(., Context, run_id) %>% 
   merge(Prev_cumulative_df,.) -> Prev_cumulative_persist_df


```

```{r, FOI and R0 calc, echo = F, warning=FALSE, message=FALSE}
ranch.df <- list_cbind(map(ranch.params, as_data_frame))
colnames(ranch.df) <-  names(ranch.params)
ranch.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Outdoor ranch"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         Context = "Outdoor ranch", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> ranch.r0

intensive.df <- list_cbind(map(intensive.params, as_data_frame))
colnames(intensive.df) <-  names(intensive.params)
intensive.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Intensive facility"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Intensive facility", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> intensive.r0

rural.df <- list_cbind(map(rural.params, as_data_frame))
colnames(rural.df) <-  names(rural.params)
rural.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, rural"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, rural", Setting = "Wild") %>% 
  select(., run_id, Context, Setting,  r0) -> rural.r0

suburban.df <- list_cbind(map(suburban.params, as_data_frame))
colnames(suburban.df) <-  names(suburban.params)
suburban.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, suburban"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, suburban", Setting = "Wild") %>% 
  select(., run_id, Context, Setting, r0) -> suburban.r0

r0 <- rbind(ranch.r0,intensive.r0, rural.r0,suburban.r0)

#Merge with average prevalence (step 1) and persistence (step 2)
merge(r0,Prev_cumulative_persist_df[,c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id", all.x = TRUE) %>% 
  mutate(Context = factor(Context,  levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) -> df_initial_infections_1_in_1000
```

```{r Compiler 1:1 mil, warning=FALSE, message=FALSE}
captive.inits.fall <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999999, I_captive_prop = 0.000001, draws = nsamples)
captive.inits.steady <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999999, I_captive_prop = 0.000001, draws = nsamples, steady = TRUE)

wild.inits.fall <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999999, I_wild_prop = 0.000001, draws = nsamples)
wild.inits.steady <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999999, I_wild_prop = 0.000001, draws = nsamples, steady = TRUE)

proj.ranch <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = ranch.params, times = times, name = "Outdoor ranch")

proj.intensive <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = intensive.params, times = times, name = "Intensive facility")

proj.rural <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady ,params = rural.params, times = times, name = "Wild, rural")

proj.suburban <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady, params = suburban.params, times = times, name = "Wild, suburban")
```


```{r, Summarize prev and cumulative infections 1 in 1mil, echo=FALSE, warning=FALSE, message=FALSE}
sirs_results_contexts <- rbind(proj.ranch,proj.intensive, proj.rural, proj.suburban)

sirs_results_contexts %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[2],length(times)*nsamples), rep(unique(sirs_results_contexts$Context)[3],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[4],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
   summarize(Wild = mean(I_wild), Captive = mean(I_captive), Prevalence = Wild + Captive, Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative), Cumulative_infections = sum(Cumulative_wild_infections,Cumulative_captive_infections)) %>% 
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
   select(., -Wild, -Captive, -Cumulative_wild_infections, -Cumulative_captive_infections) %>% 
  group_by(.,Context) %>% 
  arrange(., Context, run_id) -> Prev_cumulative_df

```

```{r, Summarize persistence 1 in 1mil, echo = F, warning=FALSE, message=FALSE}

persist.threshold <- 0.001

sirs_results_contexts %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],nsamples),rep(unique(sirs_results_contexts$Context)[2],nsamples), rep(unique(sirs_results_contexts$Context)[3],nsamples),rep(unique(sirs_results_contexts$Context)[4],nsamples))) %>%
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
  mutate(., Persist.I_wild = I_wild > persist.threshold, Persist.I_captive = I_captive > persist.threshold, Persist = as.logical(Persist.I_wild + Persist.I_captive)) %>%
  select(., run_id,Context, Persist) %>%
  arrange(., Context, run_id) %>% 
   merge(Prev_cumulative_df,.) -> Prev_cumulative_persist_df


```

```{r, FOI and R0 calc 1 in 1mil, echo = F, warning=FALSE, message=FALSE}
ranch.df <- list_cbind(map(ranch.params, as_data_frame))
colnames(ranch.df) <-  names(ranch.params)
ranch.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Outdoor ranch"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         Context = "Outdoor ranch", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> ranch.r0

intensive.df <- list_cbind(map(intensive.params, as_data_frame))
colnames(intensive.df) <-  names(intensive.params)
intensive.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Intensive facility"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Intensive facility", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> intensive.r0

rural.df <- list_cbind(map(rural.params, as_data_frame))
colnames(rural.df) <-  names(rural.params)
rural.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, rural"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, rural", Setting = "Wild") %>% 
  select(., run_id, Context, Setting,  r0) -> rural.r0

suburban.df <- list_cbind(map(suburban.params, as_data_frame))
colnames(suburban.df) <-  names(suburban.params)
suburban.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, suburban"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, suburban", Setting = "Wild") %>% 
  select(., run_id, Context, Setting, r0) -> suburban.r0

r0 <- rbind(ranch.r0,intensive.r0, rural.r0,suburban.r0)

#Merge with average prevalence (step 1) and persistence (step 2)
merge(r0,Prev_cumulative_persist_df[,c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id", all.x = TRUE) %>% 
  mutate(Context = factor(Context,  levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) -> df_initial_infections_1_in_1mil
```


```{r Compiler 1:1 bil, warning=FALSE, message=FALSE}
captive.inits.fall <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999999999, I_captive_prop = 0.000000001, draws = nsamples)
captive.inits.steady <- initial_compartments(S_wild_prop = 0, S_captive_prop = 0.999999999, I_captive_prop = 0.000000001, draws = nsamples, steady = TRUE)

wild.inits.fall <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999999999, I_wild_prop = 0.000000001, draws = nsamples)
wild.inits.steady <- initial_compartments(S_captive_prop = 0, S_wild_prop = 0.999999999, I_wild_prop = 0.000000001, draws = nsamples, steady = TRUE)

proj.ranch <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = ranch.params, times = times, name = "Outdoor ranch")

proj.intensive <- run(iter = nsamples, initial_compartments = captive.inits.fall, initial_compartments_steady = captive.inits.steady, params = intensive.params, times = times, name = "Intensive facility")

proj.rural <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady ,params = rural.params, times = times, name = "Wild, rural")

proj.suburban <- run(iter = nsamples, initial_compartments = wild.inits.fall, initial_compartments_steady = wild.inits.steady, params = suburban.params, times = times, name = "Wild, suburban")
```


```{r, Summarize prev and cumulative infections 1 in 1bil, echo=FALSE, warning=FALSE, message=FALSE}
sirs_results_contexts <- rbind(proj.ranch,proj.intensive, proj.rural, proj.suburban)

sirs_results_contexts %>%
  mutate(ode_df = map(ode_proj, as.data.frame)) %>%
  pull(ode_df) %>%
  list_rbind(names_to = "run_id") %>% 
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[2],length(times)*nsamples), rep(unique(sirs_results_contexts$Context)[3],length(times)*nsamples),rep(unique(sirs_results_contexts$Context)[4],length(times)*nsamples))) %>% 
  group_by(Context, run_id) %>% 
   summarize(Wild = mean(I_wild), Captive = mean(I_captive), Prevalence = Wild + Captive, Cumulative_wild_infections = last(I_wild_cumulative), Cumulative_captive_infections = last(I_captive_cumulative), Cumulative_infections = sum(Cumulative_wild_infections,Cumulative_captive_infections)) %>% 
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
   select(., -Wild, -Captive, -Cumulative_wild_infections, -Cumulative_captive_infections) %>% 
  group_by(.,Context) %>% 
  arrange(., Context, run_id) -> Prev_cumulative_df

```

```{r, Summarize persistence 1 in 1bil, echo = F, warning=FALSE, message=FALSE}

persist.threshold <- 0.001

sirs_results_contexts %>%
  mutate(steady_sir = map(steady_state, "y"),
         steady_sir = map(steady_sir, as_tibble_row)) %>%
  pull(steady_sir) %>%
  list_rbind(names_to = "run_id") %>%
  mutate(., Context = c(rep(unique(sirs_results_contexts$Context)[1],nsamples),rep(unique(sirs_results_contexts$Context)[2],nsamples), rep(unique(sirs_results_contexts$Context)[3],nsamples),rep(unique(sirs_results_contexts$Context)[4],nsamples))) %>%
  mutate(., Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
  mutate(., Persist.I_wild = I_wild > persist.threshold, Persist.I_captive = I_captive > persist.threshold, Persist = as.logical(Persist.I_wild + Persist.I_captive)) %>%
  select(., run_id,Context, Persist) %>%
  arrange(., Context, run_id) %>% 
   merge(Prev_cumulative_df,.) -> Prev_cumulative_persist_df


```

```{r, FOI and R0 calc 1 in 1bil, echo = F, warning=FALSE, message=FALSE}
ranch.df <- list_cbind(map(ranch.params, as_data_frame))
colnames(ranch.df) <-  names(ranch.params)
ranch.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Outdoor ranch"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         Context = "Outdoor ranch", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> ranch.r0

intensive.df <- list_cbind(map(intensive.params, as_data_frame))
colnames(intensive.df) <-  names(intensive.params)
intensive.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Intensive facility"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Intensive facility", Setting = "Captive") %>% 
  select(., run_id, Context,  Setting, r0) -> intensive.r0

rural.df <- list_cbind(map(rural.params, as_data_frame))
colnames(rural.df) <-  names(rural.params)
rural.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, rural"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, rural", Setting = "Wild") %>% 
  select(., run_id, Context, Setting,  r0) -> rural.r0

suburban.df <- list_cbind(map(suburban.params, as_data_frame))
colnames(suburban.df) <-  names(suburban.params)
suburban.df %>% 
  mutate(., run_id = min(Prev_cumulative_df[which(Prev_cumulative_df$Context=="Wild, suburban"),"run_id"])+0:(nsamples-1),r0 = unlist((beta_aero_ww+beta_aero_cc+beta_dc_ww+beta_dc_cc)/gamma_recov),
         FOI = unlist((beta_aero_hw+beta_aero_hc)*I_human),
         Context = "Wild, suburban", Setting = "Wild") %>% 
  select(., run_id, Context, Setting, r0) -> suburban.r0

r0 <- rbind(ranch.r0,intensive.r0, rural.r0,suburban.r0)

#Merge with average prevalence (step 1) and persistence (step 2)
merge(r0,Prev_cumulative_persist_df[,c("run_id","Prevalence", "Persist", "Cumulative_infections")], by = "run_id", all.x = TRUE) %>% 
  mutate(Context = factor(Context,  levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) -> df_initial_infections_1_in_1bil
```

Results from these simulations are stored as `whitetailedSIRS::initial_infection_results_1_in_1000`, `whitetailedSIRS::initial_infection_results_1_in_1mil`, and `whitetailedSIRS::initial_infection_results_1_in_1bil`.

```{r, warning=FALSE, message=FALSE}
initial_infection_results_1_in_1000 <- df_initial_infections_1_in_1000
initial_infection_results_1_in_1mil <- df_initial_infections_1_in_1mil
initial_infection_results_1_in_1bil <- df_initial_infections_1_in_1bil
```

