---
title: "Summarize introduction, spread, prevalence, and persistence"
author: "Elias Rosenblatt"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Summarize introduction, spread, prevalence, and persistence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(whitetailedSIRS)
library(ggplot2)
library(tidyverse)
library(binom)
library(stringr)
```

## Introduction
Now that we have a dataset from our simulations in the vignettes `whitetailedSIRS::SIRS_analysis_by_context.Rmd` and `whitetailedSIRS::SIRS_analysis_by_context_initialspill.Rmd`, we can begin to visualize how various characteristics of outbreaks differ between contexts. These figures are used in the results published in *Rosenblatt et al. In Prep.*. Here, we load the data set `whitetailedSIRS::scenario_results` summarizing each simulation (df), the data set `whitetailedSIRS::scenario_projections` containing daily compartment sizes for each simulation (outbreaks), and remind R how many iterations were run in each context (nsamples).
```{r}
df <- whitetailedSIRS::scenario_results
outbreaks <- whitetailedSIRS::scenario_projections
nsamples <- 200
```

## Strength of introduction (FOI) and spread (R0)

We summarize the basic reproductive number ($R_0$) and the Force-Of_Infection from humans to deer ($FOI_{HD}$) for each scenario below, producing Figure 3 in Rosenblatt et al. In Prep.:

```{r, message = F, warning = F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
#plot r0
ggplot(df, aes(x = Context, y = r0)) +
  geom_boxplot(width = 0.5)+
  theme_classic()+
  geom_hline(yintercept = 1)+
   coord_cartesian(ylim = c(0,20))+
  scale_y_continuous("Basic reproductive number (R0)")+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> r0

#plot FOI
ggplot(df, aes(x = Context, y = log10(FOI*100))) +
  geom_boxplot(width = 0.5)+
  theme_classic()+
    coord_cartesian(ylim = c(-9,0))+
  scale_y_continuous("Percent susceptible deer infected\nby humans per day (FOI; log-10 scale)", breaks = c(-9,-6,-3,-1))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> FOI

#Plot P>=1 infection out of 100
ggplot(df, aes(x = Context, y = 1-(exp(-FOI*120))^1000)) +
  geom_boxplot(width = 0.5)+
  theme_classic()+
  scale_y_continuous("Probability of at least 1 HtD transmission\nper 1000 deer during 120-day projection", limits = c(0,1))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> pinfect

ggpubr::ggarrange(FOI, pinfect ,r0, nrow =1, ncol=3)
```

## Outbreak Projections
We can visually compare the distribution of outbreak frequency, and peak size and timing across the four scenarios considered. The code below produces Figure 4 in Rosenblatt et al. In Prep.:
```{r, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
outbreaks %>% 
   filter(., Context %in% c("Outdoor ranch")) %>% 
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") %>% 
   ggplot(., aes(x = time, y = I_captive*100, group = run_id)) +
   geom_line(size = 0.1) +
   labs(x = "Time (days)", y = "Prevalence in captive deer (%)") +
   scale_y_continuous(limits = c(0,100))+
   scale_x_continuous(limits = c(0,120), breaks = c(0,30,60,90,120))+
   theme_classic()+
   theme(axis.title = element_text(size = 12),
         axis.text = element_text(size = 10),
         axis.title.x = element_blank(),
         axis.text.x = element_blank())+
   annotate("label", label  = "Outdoor ranch facility", x = 80, y = 60, size = 4) -> outdoor_ranch_outbreak

outbreaks %>% 
   filter(., Context %in% c("Intensive facility")) %>% 
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") %>% 
   ggplot(., aes(x = time, y = I_captive*100, group = run_id)) +
   geom_line(size = 0.1) +
   labs(x = "Time (days)", y = "Prevalence in captive deer (%)") +
   scale_y_continuous(limits = c(0,100))+
   scale_x_continuous(limits = c(0,120), breaks = c(0,30,60,90,120))+
   theme_classic()+
   theme(axis.title = element_blank(),
         axis.text = element_blank())+
   annotate("label", label  = "Intensive facility", x = 80, y = 60, size = 4) -> intensive_facility_outbreak

outbreaks %>% 
   filter(., Context %in% c("Wild, rural")) %>% 
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") %>% 
   ggplot(., aes(x = time, y = I_wild*100, group = run_id)) +
   geom_line(size = 0.1) +
   labs(x = "Time (days)", y = "Prevalence in wild deer (%)") +
   scale_y_continuous(limits = c(0,100))+
   scale_x_continuous(limits = c(0,120), breaks = c(0,30,60,90,120))+
   theme_classic()+
   theme(axis.title = element_text(size = 12),
         axis.text = element_text(size = 10))+
   annotate("label", label  = "Wild deer in rural setting", x = 80, y = 60, size = 4) -> wild_rural_outbreak

outbreaks %>% 
   filter(., Context %in% c("Wild, suburban")) %>% 
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") %>% 
   ggplot(., aes(x = time, y = I_wild*100, group = run_id)) +
   geom_line(size = 0.1) +
   labs(x = "Time (days)", y = "Prevalence in captive deer (%)") +
   scale_y_continuous(limits = c(0,100))+
   scale_x_continuous(limits = c(0,120), breaks = c(0,30,60,90,120))+
   theme_classic()+
   theme(axis.title.x = element_text(size = 12),
         axis.text.x = element_text(size = 10),
         axis.title.y = element_blank(),
         axis.text.y = element_blank())+
   annotate("label", label  = "Wild deer in suburban setting", x = 80, y = 60, size = 4) -> wild_suburban_outbreak

ggpubr::ggarrange(outdoor_ranch_outbreak, intensive_facility_outbreak, wild_rural_outbreak, wild_suburban_outbreak)
```


## Prevalence, Incidence, and Persistence

We summarize the average prevalence, incidence proportion, and probability of persistence for each scenario below, producing Figure 5 in Rosenblatt et al. In Prep.:

```{r, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
ggplot(df, aes(x = Context, y = Prevalence*100)) +
  geom_boxplot(width = 0.5)+
  theme_classic()+
  scale_y_continuous("Average prevalence (%)")+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> prevalence

#plot persistence
group_by(df, Context) %>% 
  summarize(., Persistence = sum(Persist)) %>% 
  mutate(LCL = binom.confint(Persistence, n = nsamples, methods = "exact")$lower, pred = binom.confint(Persistence, n = nsamples, methods = "exact")$mean ,UCL = binom.confint(Persistence, n = nsamples, methods = "exact")$upper) %>% 
  mutate(Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
  ggplot(., aes(x = Context, y = pred))+
  geom_point()+
  geom_errorbar(aes(ymin = LCL, ymax = UCL), width = 0.5)+
  scale_fill_grey()+
  theme_classic()+
  scale_y_continuous("Probability of persistence", limits = c(0,1))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> persistence

ggplot(df, aes(x = Context, y = Cumulative_infections)) +
  geom_boxplot(width = 0.5)+
  theme_classic()+
  scale_y_continuous("Incidence proportion")+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> incidence_proportion


ggpubr::ggarrange(prevalence, persistence,incidence_proportion,nrow =1, ncol=3)
```

## Interaction between strengths of introduction and spread, and prevalence, cumulative infections, and persistence.

We summarize how how Force-Of-Infection from humans to deer ($FOI_{HD}$) and SARS-CoV-2's basic reproductive number ($R_0$) interact in outbreak characteristics. The code below produces Figure 6 in Rosenblatt et al. In Prep.:

```{r, warning=FALSE, message=FALSE, fig.align='center',out.width="100%", , fig.height = 8, fig.width = 14}
#Composite plot showing how R0 and FOI interact to impact prevelence
df %>% 
  mutate(., r0_bin = case_when(r0 <= 1 ~ "Unsustained spread",
                               r0 > 1 & r0 <= 3 ~ "Low spread",
                               r0 > 3 & r0 <= 5 ~ "Medium spread",
                               r0 > 5 ~ "High spread"), 
         r0_bin = factor(r0_bin, levels = c("Unsustained spread","Low spread","Medium spread","High spread"))) %>% 
  ggplot(., aes(log10(FOI),Prevalence*100))+
  geom_point(aes(color = Context))+
  facet_grid(.~r0_bin)+
  scale_color_manual(values = c("black","gray80", "#66A61E","#66D61E"))+
  stat_smooth(method = "glm", method.args = list(family=quasi(link='log')), formula = y~x, color = "black")+
  scale_y_continuous(name = "Average prevalence (%)", limits = c(0,20))+
   scale_x_continuous(name = "Introduction hazard from humans (log10 FOI)", breaks = c(-9,-6,-4))+
  theme_classic()+
  theme(strip.text = element_text(size = 12),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),axis.text.y = element_text(size = 10), legend.text = element_text(size=10), legend.title = element_text(size=12)) -> Prevalence.plot

df %>% 
  mutate(., r0_bin = case_when(r0 <= 1 ~ "Unsustained spread",
                               r0 > 1 & r0 <= 3 ~ "Low spread",
                               r0 > 3 & r0 <= 5 ~ "Medium spread",
                               r0 > 5 ~ "High spread"), 
         r0_bin = factor(r0_bin, levels = c("Unsustained spread","Low spread","Medium spread","High spread"))) %>%
  ggplot(., aes(log10(FOI),as.numeric(Persist)))+
  geom_point(aes(color = Context))+
  scale_color_manual(values = c("black","gray80", "#66A61E","#66D61E"))+
  facet_grid(.~r0_bin)+
  stat_smooth(method = "glm",method.args = list(family = "binomial"), se = F, color = "gray20")+
  scale_y_continuous(name = "Probability of persistence", limits = c(0,1), breaks = c(0,1))+
   scale_x_continuous(name = "Introduction hazard from humans (log10 FOI)", breaks = c(-9,-6,-4))+
  theme_classic()+
  theme(strip.text = element_text(size = 12),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),axis.text.y = element_text(size = 10), legend.text = element_text(size=10), legend.title = element_text(size=12))  ->  Persistence.plot

df %>% 
  mutate(., r0_bin = case_when(r0 <= 1 ~ "Unsustained spread",
                               r0 > 1 & r0 <= 3 ~ "Low spread",
                               r0 > 3 & r0 <= 5 ~ "Medium spread",
                               r0 > 5 ~ "High spread"), 
         r0_bin = factor(r0_bin, levels = c("Unsustained spread","Low spread","Medium spread","High spread"))) %>%
  ggplot(., aes(log10(FOI*100),Cumulative_infections))+
  geom_point(aes(color = Context))+
  facet_grid(.~r0_bin)+
  scale_color_manual(values = c("black","gray80", "#66A61E","#66D61E"))+
  stat_smooth(method = "glm", method.args = list(family=quasi(link='log')), formula = y~x, color = "black")+
  scale_y_continuous(name = "Incidence proportion")+
scale_x_continuous(name = "Percent susceptible deer infected by humans per day (FOI; log-10 scale)", breaks = c(-9,-6,-3,-1))+
  theme_classic()+
  theme(strip.text = element_text(size = 12),
        axis.title.y = element_text(size = 12),axis.text = element_text(size = 10), legend.text = element_text(size=10), legend.title = element_text(size=12)) -> Incidence.plot

ggpubr::ggarrange(Prevalence.plot, Persistence.plot, Incidence.plot,nrow =3, ncol=1, common.legend = T)+
  annotate("label", x = 0.1, y = .85, label = "A", fill = "white", size = 6) +
  annotate("label", x = 0.1, y = .55, label = "B", fill = "white", size = 6) +
   annotate("label", x = 0.1, y = .25, label = "C", fill = "white", size = 6)
```

## Compare outbreak characteristics for initial and continuous spillover

Here, we visualize differences in outbreak characteristics when there is continuous transmission from humans (as all cases plotted above) vs when there is a single, initial outbreak of various sizes. These initial outbreaks range from in 0.1% (1:1,000 deer), 0.0001% (1:1 million deer), and 1e-7% (1:1 billion deer). The resulting figure corresponds with Figure 7 in Rosenblatt et al. In Prep.

```{r, warning=FALSE, message=FALSE, fig.align='center',out.width="100%", fig.height = 8, fig.width = 14}
whitetailedSIRS::scenario_results %>% 
   mutate(., intro = "Continuous\nintroduction") %>% 
   select(., -r0, -FOI) -> continuous

whitetailedSIRS::initial_infection_results_1_in_1000 %>% 
   mutate(., intro = "0.1%\ninitially infected") %>% 
   select(., -r0) -> initial_high

whitetailedSIRS::initial_infection_results_1_in_1mil %>% 
   mutate(., intro = "0.0001%\ninitially infected") %>% 
   select(., -r0) -> initial_med

whitetailedSIRS::initial_infection_results_1_in_1bil %>% 
   mutate(., intro = "10e-7%\ninitially infected") %>% 
   select(., -r0) -> initial_low

rbind(continuous, initial_high, initial_med, initial_low) %>% 
   mutate(intro = factor(intro, levels = c("Continuous\nintroduction","0.1%\ninitially infected", "0.0001%\ninitially infected", "10e-7%\ninitially infected")),
          Cumulative_infections = Cumulative_infections)-> spillover.df

spillover.df %>% 
   ggplot(., aes(x = intro, y = Prevalence))+
   geom_boxplot(width = 0.5)+
   facet_grid(Context ~.)+
   scale_y_continuous(name = "Average prevalence (%)")+
   theme_classic()+
   theme(axis.title.x = element_blank(),
         strip.background = element_blank(),
         strip.text.y = element_blank())-> spillover_prev_plot

spillover.df %>% 
   group_by(Context, intro) %>% 
   summarize(., LCL = binom.confint(x = sum(Persist),n = 200, methods = "exact", conf.level = 0.95)$lower,
             mean = binom.confint(x = sum(Persist),n = 200, methods = "exact", conf.level = 0.95)$mean,
             UCL = binom.confint(x = sum(Persist),n = 200, methods = "exact", conf.level = 0.95)$upper) %>% 
   ggplot(., aes(x = intro, y = mean))+
   geom_point()+
   geom_errorbar(aes(ymin = LCL, ymax = UCL), width = 0.5)+
   facet_grid(Context ~.)+
   scale_y_continuous(name = "Probability of persistence")+
   theme_classic()+
   theme(axis.title.x = element_blank(),
         strip.background = element_blank(),
         strip.text.y = element_blank()) -> spillover_presist_plot

spillover.df %>% 
   ggplot(., aes(x = intro, y = Cumulative_infections))+
   geom_boxplot(width = 0.5)+
   facet_grid(Context ~.)+
   scale_y_continuous(name = "Incidence proportion")+
   theme_classic()+
   theme(axis.title.x = element_blank()) -> spillover_cumulative_plot

ggpubr::ggarrange(spillover_prev_plot, spillover_presist_plot, spillover_cumulative_plot, ncol = 3)
```
