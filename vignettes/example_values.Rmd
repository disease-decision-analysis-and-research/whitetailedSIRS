---
title: "example_values"
subtitle: "Introduction to a simple projection using whitetailedSIRS"
author: "F. Javiera Rudolph, Elias Rosenblatt"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example_values}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(whitetailedSIRS)
library(tidyverse)
library(deSolve)
library(rootSolve)
```


As a first example, we will use the defaults for all the values, and run one projection of the SIRS model. These defaults are produced as random draws from the expert elicitation data.

First, load the data, and generate a random sample for each of the parameters using the `draw_elicitation_samples.R` function from the whitetailedSIRS package: 
```{r}
set.seed(23)
nsamples <- 50

EE_data <- whitetailedSIRS::elicitation_data
# bind samples to the elicitation df

whitetailedSIRS::draw_elicitation_samples(elicitation_data = EE_data, nsamples = nsamples,seed = 23) -> elicitation_data
```

With the previous code we generated a sample of `r nsamples` values for each of the parameters elicited, using the appropriate distribution. We will use some of those parameters now to calculate our transmission terms and other parameters that go into the SIRS model. The `elicitation_data` object is a tibble, and the sample of values for each parameter is a vector of values within each cell of the tibble for the `my_sample` column:
```{r}
slice_head(elicitation_data, n = 5)
```

We write a short helper function to help us extract each of the vectors in the `my_sample` column, so these can be assigned to the different parameters. This function `get_EE_param_vals.R` is available for use from the whitetailedSIRS package.

```{r}
get_EE_param_vals <- function(my_param){
   elicitation_data %>%
      filter(parameter == my_param) %>%
      unnest(cols = c(my_sample)) %>%
      pull(my_sample)
}
```

We set up all the parameters that were generated from the expert elicitation distributions:

```{r}
# The immunity parameter that goes into the SIR is the reciprocal to what was elicited
alpha_immunity <- 1 / get_EE_param_vals('Temporary Immunity')

# Calculate contact rate between wild deer using the contact_rate fx using defaults (see ?calc_contact_rate for details):
omega_ww <- whitetailedSIRS::calc_contact_rate(nsamples = nsamples, type_contact = "low")
# The rest of the contact rates were elicited and then modified
omega_cw <- 0.00072 / get_EE_param_vals("Direct Contact Probability")
omega_cc <- get_EE_param_vals("Deer-Deer Proximity Rate, Captive (per day)")
omega_hw <- get_EE_param_vals("Deer-Human Proximity Rate, Rural (per 120 days)") / 120
omega_hc <- get_EE_param_vals("Deer-Human Proximity Rate, Captive (per 120 days)") /120

# time or duration of these contacts was also expert elicited:
t_contact_deer_deer <- get_EE_param_vals("Deer Proximity Duration (minutes)")
t_contact_deer_human_rural <- get_EE_param_vals("Deer-Human Proximity Duration, Rural (minutes)")
t_contact_deer_human_capt <- get_EE_param_vals("Deer-Human Proximity Duration, Captive (minutes)")

# Viral load proportional to human value:
C_nu <- 10^5.6 * get_EE_param_vals("Viral Load")

# Dose response
r_deer <- get_EE_param_vals("Dose-Response")

# Direct contact probability (same for all deer):
epsilon_dc <- get_EE_param_vals("Direct Contact Probability")
```


Using the sets of parameters from expert elicitation we calculate probability of infection via aerosol and direct contact. These calculations are also informed by parameters from the literature, and details on this can be found in the `sir_model_description` document/article. The calc_sigma_aero and calc_sigma_dc functions listed below are included in the `whitetailedSIRS` package.


```{r}
# aerosol transmission between deer, using deer exhalation/inhalation rates (default)
sigma_aero_deer_deer <- whitetailedSIRS::calc_sigma_aero(C_nu = C_nu,
                                  t_contact = t_contact_deer_deer / 60,
                                  r = r_deer)

# aerosol transmission from humans to deer, modifying exhalation rates to that of a human
sigma_aero_deer_human_rural <- whitetailedSIRS::calc_sigma_aero(ER = rep(0.53, nsamples), C_nu = C_nu, t_contact = t_contact_deer_human_rural/60, r = r_deer)
sigma_aero_deer_human_capt <- whitetailedSIRS::calc_sigma_aero(ER = rep(0.53, nsamples), C_nu = C_nu, t_contact = t_contact_deer_human_capt/60, r = r_deer)

# direct contact fluid transmission between deer
sigma_dc_deer_deer <- whitetailedSIRS::calc_sigma_dc(C_nu = C_nu)

# Some additional parameters:
gamma_recov <- rep(1/6, nsamples) #Inverse of 6 day recovery period from infection
I_human <- rep(0.05, nsamples) #Fixed human prevalence level (5%)
boost <- rep(0, nsamples) #No vaccine boosters administered to captive populations
```

Now that we have all the parameters we need, we can set up the inputs for the `ode()` function. First, we list the initial compartment sizes to calculate how these compartments change through an outbreak, and calculate the steady state equilibrium size of the infected compartments:

```{r}
#Compartment sizes formatted to calculate daily prevalence and cumulative infections:
list_inits <- list(
   S_wild = rep(1, nsamples),
   I_wild = rep(0, nsamples),
   R_wild = rep(0, nsamples),
   I_wild_cumulative = rep(0, nsamples),
   S_captive = rep(1, nsamples),
   I_captive = rep(0, nsamples),
   R_captive = rep(0, nsamples),
   I_captive_cumulative = rep(0,nsamples)
)

#Compartment sizes formatted to calculate steady state equilibrium dynamics:
list_inits_steady <- list(
   S_wild = rep(1, nsamples),
   I_wild = rep(0, nsamples),
   R_wild = rep(0, nsamples),
   S_captive = rep(1, nsamples),
   I_captive = rep(0, nsamples),
   R_captive = rep(0, nsamples)
)

#Calculate the derived parameters necessary for use with simple_sirs.R and simple_sirs_with_cumulative.R. This can be done either as a list by hand...:
list_params <- list(
   alpha_immunity = alpha_immunity,
   beta_aero_ww = omega_ww * sigma_aero_deer_deer,
   beta_aero_cw = omega_cw * sigma_aero_deer_deer,
   beta_aero_cc = omega_cc * sigma_aero_deer_deer,
   beta_aero_hw = omega_hw * sigma_aero_deer_human_rural,
   beta_aero_hc = omega_hc * sigma_aero_deer_human_capt,
   beta_dc_ww = omega_ww * epsilon_dc * sigma_dc_deer_deer,
   beta_dc_cw = omega_cw * epsilon_dc * sigma_dc_deer_deer,
   beta_dc_cc = omega_cc * epsilon_dc * sigma_dc_deer_deer,
   gamma_recov = gamma_recov,
   I_human = I_human,
   boost = boost
)

#... or using the alternative.R function from the whitetailedSIRS package:
list_params <- alternative(alpha_immunity = alpha_immunity, omega_ww = omega_ww, omega_cw = omega_cw, omega_cc = omega_cc, omega_hw = omega_hw, omega_hc = omega_hc, sigma_aero_deer_deer_wild = sigma_aero_deer_deer, sigma_aero_deer_deer_captive = sigma_aero_deer_deer, sigma_aero_deer_human_wild = sigma_aero_deer_human_rural, sigma_aero_deer_human_capt = sigma_aero_deer_human_capt, epsilon_dc = epsilon_dc, sigma_dc_deer_deer = sigma_dc_deer_deer, gamma_recov = gamma_recov, I_human = I_human, boost = boost)


#Set a sequence of days to model outbreaks
times <- seq(0, 120, by = 1)
```

We continue to work with list columns here so we can keep track of the sets of parameters associated to each of the projections:

```{r}
# create list column to store inits and params
mytibble <- tibble(run_id = 1:nsamples,
                   inits.outbreak = map(run_id, ~ list_inits %>% map_dbl(., .x)),
                   inits.steady = map(run_id, ~ list_inits_steady %>% map_dbl(., .x)),
                   params = map(run_id, function(x) list_params %>% map_dbl(., x)))

# create a new column that stores the results from the ode() projection using the simple_sirs_with_cumulative SIRS ODE equations to calculate daily compartment sizes and cumulative infections,...
mytibble %>%
   mutate(ode_proj = pmap(list(y = inits.outbreak, parms = params), ode, times = seq(0, 120, by = 1), func = simple_sirs_with_cumulative)) %>% 
   # ..., and create another column that stores the equilibrium for these:
   mutate(steady_state = pmap(list(y = inits.steady, parms = params), runsteady, func = simple_sirs)) -> sirs_results # save as new object

#This can also be done using the run() function from the whitetailedSIRS package:
sirs_results <- run(iter = nsamples, initial_compartments = list_inits, initial_compartments_steady = list_inits_steady, params = list_params, times = times, name = "Example Values")

slice_head(sirs_results, n = 3)
```

From our results we can visualize the proportion of infected individuals over time for each of the runs:
```{r}
# get results in proper format:
sirs_results %>%
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") -> ode_df

ode_df %>%
   ggplot(., aes(x = time, y = I_wild, group = run_id)) +
   geom_line() +
   labs(x = "Time in days", y = "Proportion of infected, wild individuals") +
   theme_bw()
```

We can calculate the cumulative proportion of the population that is infected over the course of the projection:
```{r}
# get results in proper format:
sirs_results %>%
   mutate(ode_df = map(ode_proj, as.data.frame)) %>%
   pull(ode_df) %>%
   list_rbind(names_to = "run_id") -> ode_df

ode_df %>%
   ggplot(., aes(x = time, y = I_wild_cumulative, group = run_id)) +
   geom_line() +
   labs(x = "Time in days", y = "Proportion of I_w individuals") +
   theme_bw()
```

We can also take a look at how all compartments change over time (excluding the cumulative infection calculations): 
```{r}

ode_df %>%
   select(., -I_wild_cumulative, -I_captive_cumulative) %>% 
   pivot_longer(cols = -c(run_id, time), names_to = "compartment") %>%
   ggplot(., aes(x = time, y = value, group = run_id)) +
   facet_wrap(~compartment) +
   geom_line() +
   labs(x = "Time in days", y = "Proportion of population") +
   theme_bw()
```


And check the steady state, or equilibrium, for all of these runs: 

```{r}
sirs_results %>%
   mutate(steady_sir = map(steady_state, "y"),
          steady_sir = map(steady_sir, as_tibble_row)) %>% 
   pull(steady_sir) %>% 
   list_rbind(names_to = "run_id") -> steady_sir

steady_sir %>% 
   pivot_longer(cols = -run_id, names_to = "compartment", values_to = "proportion") %>% 
   separate(compartment, sep = "_", c("sir_type", "pop_type")) %>% 
   mutate(sir_type = factor(sir_type, levels = c("S", "I", "R")),
          pop_type = factor(pop_type, levels = c("wild", "captive"))) %>% 
   ggplot(aes(y = proportion, color = pop_type, x = sir_type)) +
   geom_boxplot() +
   ylim(0, 1) +
   labs(x = "", color = "Population Type", y = "Proportion at equilibrium") +
   theme_bw()
```


We can also calculate some metrics such as R0 and force of infection (FOI): 

```{r}
r0_deer_wild <- ((omega_ww * sigma_aero_deer_deer) + (omega_ww * sigma_dc_deer_deer * epsilon_dc)) * 1/gamma_recov
r0_deer_captive <- ((omega_cc * sigma_aero_deer_deer) + (omega_cc * sigma_dc_deer_deer * epsilon_dc)) * 1/gamma_recov


tibble(r0_deer_wild = r0_deer_wild, r0_deer_captive = r0_deer_captive) %>% 
   pivot_longer(cols = everything()) %>% 
   ggplot(., aes(y = value)) +
   facet_wrap(~ name, scales = "free") +
   geom_hline(yintercept = 1, color = "red", linetype = "dashed") +
   geom_boxplot() +
   theme_bw() +
   theme(axis.text.x = element_blank())
```

```{r}
#FOI
foi_wild <- omega_hw * sigma_aero_deer_human_rural * I_human
foi_captive <- omega_hc * sigma_aero_deer_human_capt * I_human

tibble(foi_wild = foi_wild,foi_captive = foi_captive) %>% 
   pivot_longer(cols = everything()) %>% 
ggplot(data = ., aes(y = value)) +
   geom_boxplot() +
   facet_wrap(~ name, scales = "free") +
   geom_boxplot() +
   theme_bw() +
   theme(axis.text.x = element_blank())
```

